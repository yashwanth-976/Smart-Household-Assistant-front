<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Household Assistant - Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <link rel="manifest" href="manifest.json">

  <!-- Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-init.js"></script>





  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-messaging.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBqB_cOk2ESbtHxCYkQRh3rx4P6WHqDpiQ",
      authDomain: "smart-expiry-fcm.firebaseapp.com",
      projectId: "smart-expiry-fcm",
      storageBucket: "smart-expiry-fcm.firebasestorage.app",
      messagingSenderId: "327136614137",
      appId: "1:327136614137:web:31bf2948b0b909b45fb428"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const messaging = getMessaging(app);
    window.messaging = messaging; // Expose for script.js
    window.getToken = getToken;   // Expose for script.js
    window.onMessage = onMessage; // Expose for script.js
  </script>

  <script>
    // PWA Service Worker Registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(req => console.log('Service Worker Registered!', req))
          .catch(err => console.log('Service Worker registration failed', err));
      });
    }

    async function checkSession() {
      // Wait a tick for init if needed, or check immediately
      if (!window.sb) {
        console.warn('Supabase not fully loaded yet');
        return;
      }

      const { data: { session } } = await window.sb.auth.getSession();
      if (!session) {
        window.location.href = 'auth.html';
      }
    }
    // Simple check on load
    window.addEventListener('load', checkSession);
  </script>
</head>

<body>

  <div class="container">

    <!-- Header -->
    <header class="dashboard-header">
      <div>
        <h1 class="app-title" style="margin:0; text-align: left; font-size: 1.5rem;">Smart
          Household Assistant</h1>
        <p class="text-muted">Welcome, Guest</p>
      </div>

    </header>

    <!-- Alert Banner -->
    <div id="alert-banner" class="alert-banner hidden">
      <!-- Content injected by JS -->
    </div>
    <div id="alert-banner" class="alert-banner hidden"></div>

    <!-- Add Product Card -->
    <section class="card">
      <h2 style="font-size: 1.25rem; margin-bottom: 1rem;">Add Product</h2>
      <form id="add-product-form">
        <div class="form-group">
          <label for="product-name">Product Name</label>
          <div class="input-wrapper">
            <input type="text" id="product-name" placeholder="Product name (required)" required
              style="padding-right: 2.5rem;">
            <button type="button" id="mic-btn" class="icon-btn"
              style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); color: var(--primary);"
              title="Speak to type">
              <span class="material-icons-round">mic</span>
            </button>
          </div>
        </div>

        <div class="form-group">
          <label for="category">Category</label>
          <select id="category" required style="color: var(--text-muted);"
            onchange="this.style.color='var(--text-main)'">
            <option value="" disabled selected>Category (required)</option>
            <option value="Dairy">Dairy</option>
            <option value="Vegetables">Vegetables</option>
            <option value="Fruits">Fruits</option>
            <option value="Grains">Grains</option>
            <option value="Packaged">Packaged Food</option>
            <option value="Others">Others</option>
          </select>
        </div>

        <div class="form-row">
          <!-- Quantity -->
          <div class="form-group">
            <label for="quantity">Quantity</label>
            <input type="number" id="quantity" placeholder="Qty" required step="0.1" min="0">
          </div>

          <!-- Unit -->
          <div class="form-group">
            <label for="unit">Unit</label>
            <select id="unit">
              <option value="pcs">pcs</option>
              <option value="kg">kg</option>
              <option value="g">g</option>
              <option value="L">L</option>
              <option value="ml">ml</option>
            </select>
          </div>

          <!-- Price -->
          <div class="form-group">
            <label for="price">Price (‚Çπ)</label>
            <input type="number" id="price" placeholder="0.00" min="0" step="0.01">
          </div>

          <!-- Expiry Date -->
          <div class="form-group">
            <label for="expiry-date">Expiry Date</label>
            <div class="input-wrapper">
              <input type="date" id="expiry-date" required
                style="padding-right: 0.5rem; background: #fff; cursor: text;">
            </div>
          </div>
        </div>


        <button type="submit" class="btn btn-primary" style="margin-top: 0.5rem;">Add to
          Inventory</button>
      </form>
    </section>

    <!-- Inventory Section -->
    <section class="inventory-section">
      <div
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; margin-top: 0.5rem;">
        <h3>Your Inventory</h3>
      </div>

      <!-- List Items (Dynamic) -->
      <div id="inventory-list">
        <!-- Populated by JS -->
      </div>

      <!-- Bottom spacing for scrolling -->
      <!-- Bottom spacing for scrolling -->
      <div style="height: 50px;"></div>

      <div style="height: 80px;"></div> <!-- Extra space for FAB -->

      <div style="height: 80px;"></div> <!-- Extra space for FAB -->
    </section>

    <!-- User Floating Action Button (Bottom Right) -->
    <div class="fab-container">
      <!-- Expiry Bell Button (Stacked atop) -->
      <div class="fab-sub-item" id="expiry-notification-btn" title="Expiry Alerts">
        <span class="material-icons-round">notifications</span>
      </div>

      <!-- Sub Buttons (Hidden by default) -->
      <div class="fab-sub-container hidden" id="fab-menu">
        <div class="fab-sub-item" id="menu-ai" title="AI Assistant">
          <span class="material-icons-round">psychology</span>
        </div>
        <div class="fab-sub-item" id="menu-viz" title="Visualization">
          <span class="material-icons-round">bar_chart</span>
        </div>
      </div>

      <!-- Main User Toggle -->
      <div class="fab-main-user" id="user-fab-btn">
        <span class="material-icons-round" style="font-size: 2rem;">person</span>
      </div>
    </div>

    <!-- Independent LOGOUT Button (Below FAB) -->
    <button class="fab-logout" id="exit-app-btn" title="Logout">
      <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="currentColor">
        <path d="M0 0h24v24H0z" fill="none" />
        <path
          d="M10.09 15.59L11.5 17l5-5-5-5-1.41 1.41L12.67 11H3v2h9.67l-2.58 2.59zM19 3H5c-1.11 0-2 .9-2 2v4h2V5h14v14H5v-4H3v4c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z" />
      </svg>
    </button>


    <section id="visualization-section" class="hidden">
      <div class="dashboard-header">
        <h2 style="margin:0;">Analytics</h2>
        <button id="close-viz-btn" class="btn-ghost" style="font-size: 1.5rem;">&times;</button>
      </div>

      <!-- Budget Warning Ribbon -->
      <div id="budget-warning" class="alert-banner hidden"
        style="background: #FFF7ED; border-left-color: #F97316; color: #9A3412; margin-bottom: 1rem;">
        <span class="material-icons-round" style="margin-right: 0.5rem; font-size: 1.2rem;">warning</span>
        <span>You have exceeded your monthly budget</span>
      </div>

      <!-- Summary Card -->
      <div class="card" style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white;">
        <h3 style="color: white; opacity: 0.9; font-size: 1rem;">Total
          Inventory Value</h3>
        <p id="total-inventory-value" style="font-size: 2rem; font-weight: 700; margin-top: 0.5rem;">‚Çπ0.00</p>
      </div>

      <!-- Controls -->
      <div
        style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 1rem; gap: 1rem;">
        <div style="flex: 1;">
          <label for="budget-input"
            style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.25rem; display: block;">Monthly Budget
            (‚Çπ)</label>
          <input type="number" id="budget-input" placeholder="Set Budget" style="padding: 0.5rem;">
        </div>
        <div>
          <label for="viz-time-filter"
            style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.25rem; display: block;">Time
            Period</label>
          <select id="viz-time-filter" style="width: auto; padding: 0.5rem;">
            <option value="monthly">Monthly Trend</option>
            <option value="weekly">Weekly Trend</option>
          </select>
        </div>
      </div>

      <!-- Charts -->
      <div class="card">
        <h3>Category Breakdown</h3>
        <div style="position: relative; height: 300px;">
          <canvas id="categoryPieChart"></canvas>
        </div>
        <!-- Category List -->
        <div id="category-list"
          style="margin-top: 1.5rem; border-top: 1px solid var(--border); padding-top: 1rem; display: grid; gap: 0.5rem;">
          <!-- Dynamic Content -->
        </div>
      </div>

      <div class="card">
        <h3>Spending Trend</h3>
        <div style="position: relative; height: 300px;">
          <canvas id="trendBarChart"></canvas>
        </div>
      </div>
    </section>

  </div>

  <!-- Analysis Modal -->
  <div id="analysis-modal" class="modal hidden">
    <div class="modal-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3>Inventory Value</h3>
        <button class="btn-ghost" id="close-analysis" style="font-size: 1.5rem;">&times;</button>
      </div>
      <canvas id="priceChart"></canvas>
      <div id="analysis-details" style="margin-top: 1rem;"></div>
    </div>
  </div>

  <!-- AI Modal -->
  <div id="ai-modal" class="modal hidden">
    <div class="modal-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3>Smart AI Assistant</h3>
        <button class="btn-ghost" id="close-ai" style="font-size: 1.5rem;">&times;</button>
      </div>
      <div style="background: #f3f4f6; padding: 1rem; border-radius: 0.5rem; min-height: 150px; margin-bottom: 1rem;">
        <p class="text-muted">AI: Hello! Ask me for recipes based on your expiring items.</p>
      </div>
      <div style="display: flex; gap: 0.5rem;">
        <input type="text" placeholder="Type a message..." style="margin: 0;">
        <button class="btn btn-primary" style="width: auto;">Send</button>
      </div>
    </div>
  </div>

  <!-- AI Dashboard Section (New) -->
  <section id="ai-dashboard-section" class="hidden">
    <div class="dashboard-header">
      <h2 style="margin:0;">Chef AI üç≥</h2>
      <button id="close-ai-btn" class="btn-ghost" style="font-size: 1.5rem;">&times;</button>
    </div>

    <!-- Inventory Chips (Horizontal Scroll) -->
    <div class="inventory-chips-container">
      <p class="text-muted" style="font-size: 0.8rem; margin-bottom: 0.5rem;">Based
        on your inventory:</p>
      <div id="ai-inventory-chips" class="chips-scroll">
        <!-- JS Populated -->
      </div>
    </div>

    <!-- Chat Area -->
    <div id="ai-chat-container" class="chat-container">
      <div class="chat-bubble ai-bubble">
        Hello! üëã I see your inventory. Want to cook something specific or need a suggestion?
      </div>
    </div>

    <!-- Input Area -->
    <div class="ai-input-area">
      <div class="input-wrapper" style="width: 100%;">
        <input type="text" id="ai-user-input" placeholder="Ask e.g. 'Can I make pasta?'..." autocomplete="off">
        <button id="ai-mic-btn" class="icon-btn"
          style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); color: var(--primary);">
          <span class="material-icons-round">mic</span>
        </button>
      </div>
      <button id="ai-send-btn" class="btn-icon"
        style="background: var(--primary); color: white; width: 42px; height: 42px; margin-left: 0.5rem;">
        <span class="material-icons-round">send</span>
      </button>
    </div>
  </section>

  <script src="script.js"></script>
</body>

</html>
